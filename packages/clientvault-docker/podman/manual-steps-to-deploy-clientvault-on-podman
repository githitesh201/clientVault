#!/bin/bash
set -e
if [ ! -f "$(dirname "$0")/.env" ]; then
    echo "Error: .env file not found"
    exit 1
fi
source "$(dirname "$0")/.env"

## steps to cleanup and start over from scratch - useful when testing
#podman pod stop clientvault-pod
#podman pod rm clientvault-pod
#podman volume rm clientvault-db-data clientvault-server-data clientvault-redis-data
# end of cleanup

podman volume create clientvault-db-data
podman volume create clientvault-server-data
podman volume create clientvault-redis-data

podman pod create --name clientvault-pod -p 127.0.0.1:8080:3000

podman run -d --pod clientvault-pod --name clientvault-db \
  -e POSTGRES_DB=clientvault \
  -e POSTGRES_USER=clientvault \
  -e POSTGRES_PASSWORD="$POSTGRES_PASSWORD" \
  -v clientvault-db-data:/var/lib/postgresql/data:Z \
  docker.io/library/postgres:16

podman run -d --pod clientvault-pod --name clientvault-redis \
  -v clientvault-redis-data:/data:Z \
  docker.io/library/redis:latest

podman run -d --pod clientvault-pod --name clientvault-server \
  -e NODE_PORT=3000 \
  -e SERVER_URL="$SERVER_URL" \
  -e PG_DATABASE_URL="postgresql://clientvault:$POSTGRES_PASSWORD@clientvault-db:5432/clientvault" \
  -e REDIS_URL="redis://clientvault-redis:6379" \
  -e APP_SECRET="$APP_SECRET" \
  -e NODE_ENV=production \
  -e LOG_LEVEL=info \
  -v clientvault-server-data:/app/docker-data:Z \
  docker.io/clientvaultcrm/clientvault:latest

podman run -d --pod clientvault-pod --name clientvault-worker \
  --init \
  -e SERVER_URL="$SERVER_URL" \
  -e PG_DATABASE_URL="postgresql://clientvault:$POSTGRES_PASSWORD@clientvault-db:5432/clientvault" \
  -e REDIS_URL="redis://clientvault-redis:6379" \
  -e APP_SECRET="$APP_SECRET" \
  -e DISABLE_DB_MIGRATIONS=true \
  -e NODE_ENV=production \
  -e LOG_LEVEL=info \
  -v clientvault-server-data:/app/docker-data:Z \
  docker.io/clientvaultcrm/clientvault:latest \
  yarn worker:prod

# wait some time, check status
sleep 30
podman ps --pod -f name=clientvault-pod


mkdir -p ~/.config/systemd/user
if [ ! -f "clientvaultcrm.service" ]; then
    echo "Error: clientvaultcrm.service file not found"
    exit 1
fi
cp clientvaultcrm.service ~/.config/systemd/user

systemctl --user daemon-reload
systemctl --user enable clientvaultcrm.service
systemctl --user start clientvaultcrm.service

