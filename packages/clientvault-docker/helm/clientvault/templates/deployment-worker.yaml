{{- if .Values.worker.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "clientvault.fullname" . }}-worker
  namespace: {{ include "clientvault.namespace" . }}
  labels:
    app.kubernetes.io/name: {{ include "clientvault.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/component: worker
spec:
  replicas: {{ .Values.worker.replicaCount }}
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "clientvault.name" . }}
      app.kubernetes.io/component: worker
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "clientvault.name" . }}
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/component: worker
    spec:
      securityContext:
{{- toYaml .Values.securityContext | nindent 8 }}
      initContainers:
        - name: wait-for-db
          image: postgres:16-alpine
          command:
            - sh
            - -c
            - |
              until pg_isready -h {{ if .Values.db.enabled }}{{ include "clientvault.fullname" . }}-db{{ else }}{{ .Values.db.external.host }}{{ end }} \
                               -p {{ if .Values.db.enabled }}5432{{ else }}{{ .Values.db.external.port | default 5432 }}{{ end }} \
                               -U postgres; do
                echo "Waiting for database socket..."
                sleep 2
              done
              echo "Database socket is ready!"
      containers:
        - name: worker
          {{- $img := include "clientvault.worker.image" . }}
          image: {{ include "clientvault.image.repository" $img }}:{{ include "clientvault.image.tag" $img }}
          imagePullPolicy: {{ include "clientvault.image.pullPolicy" $img }}
          command:
{{- toYaml .Values.worker.command | nindent 12 }}
          env:
            - name: SERVER_URL
              value: {{ include "clientvault.serverUrl" . | quote }}
            {{- if eq (include "clientvault.db.useExternalSecret" .) "true" }}
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "clientvault.dbPassword.secretName" . }}
                  key: {{ include "clientvault.dbPassword.secretKey" . }}
            - name: PG_DATABASE_URL
              value: {{ include "clientvault.dbUrl.template" . | quote }}
            {{- else }}
            - name: PG_DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: {{ include "clientvault.dbUrl.secretName" . }}
                  key: url
            {{- end }}
            - name: REDIS_URL
              value: {{ include "clientvault.redisUrl" . | quote }}
            - name: STORAGE_TYPE
              value: {{ include "clientvault.storageType" . | quote }}
            - name: APP_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ include "clientvault.secret.tokens.name" . }}
                  key: accessToken
            {{- $storageEnv := (include "clientvault.storageEnv" .) }}
            {{- if $storageEnv }}
            {{ $storageEnv | nindent 12 }}
            {{- end }}
          resources:
            {{- toYaml .Values.worker.resources | nindent 12 }}
          stdin: {{ default true .Values.worker.stdin }}
          tty: {{ default true .Values.worker.tty }}
{{- end }}
