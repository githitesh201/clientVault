{{- if .Values.db.enabled }}
{{- $ns := include "clientvault.namespace" . -}}
{{- $existing := lookup "v1" "Secret" $ns (printf "%s-db-superuser" (include "clientvault.fullname" .)) -}}
{{- $user := .Values.db.internal.env.PGUSER_SUPERUSER | default "postgres" -}}
{{- $pass := .Values.db.internal.env.PGPASSWORD_SUPERUSER | default "" -}}
{{- if and $existing $existing.data.password -}}
{{- $pass = (b64dec $existing.data.password) -}}
{{- else if eq $pass "" -}}
{{- $pass = randAlphaNum 32 -}}
{{- end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "clientvault.fullname" . }}-db-superuser
  namespace: {{ include "clientvault.namespace" . }}
  labels:
    app.kubernetes.io/name: {{ include "clientvault.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/component: db
type: Opaque
stringData:
  username: {{ $user | quote }}
  password: {{ $pass | quote }}
{{- end }}
